# openGauss数据库实验报告

## 一、数据库表设计

### 表结构设计

本实验设计了五张表，具体说明如下：

#### 1.1学生表 (students)
```sql
create table students(
    id int not null,
    name varchar(50) not null,
    age int not null,
    primary key (id)
);
```

- `id`: 学生学号，主键，整型
- `name`: 学生姓名，非空，最大50字符
- `age`: 学生年龄，非空，整型

#### 1.2教师表 (teachers)
```sql
create table teachers(
    id int not null,
    name varchar(50) not null,
    age int not null,
    primary key (id)
);
```

- `id`: 教师工号，主键，整型
- `name`: 教师姓名，非空，最大50字符
- `age`: 教师年龄，非空，整型

#### 1.3课程表 (courses)
```sql
create table courses(
    id int not null,
    name varchar(50) not null,
    primary key (id)
);
```

- `id`: 课程编号，主键，整型
- `name`: 课程名称，非空，最大50字符

#### 1.4 学生选课表 (students_courses)
```sql
create table students_courses(
    student_id int not null,
    course_id int not null
);
```

- `student_id`: 学生学号，外键引用students(id)
- `course_id`: 课程编号，外键引用courses(id)

#### 1.5教师授课表 (instructors_courses)
```sql
create table instructors_courses(
    instructor_id int not null,
    course_id int not null,
    primary key (instructor_id,course_id),
    foreign key (instructor_id) references teachers(id),
    foreign key (course_id) references courses(id)
);
```

- `instructor_id`: 教师工号，外键引用teachers(id)
- `course_id`: 课程编号，外键引用courses(id)
- 联合主键：(instructor_id, course_id)



创建一个school模式，在这个模式中创建上述的表，结果如下：
![image-20251016163949717](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016163949717.png)

## 二、基本增删改查操作

### 2.1 插入操作 

**操作内容：**
```sql
insert into students(id,name,age) values (5,'Emily',24);
```

**功能说明：** 向学生表中插入一条新记录，学号为5，姓名为Emily，年龄为24岁。

**执行结果截图：**
![image-20251016164126338](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164126338.png)

2.2 删除操作 (DELETE)

**操作内容：**
```sql
delete from students where id = 5;
```

**功能说明：** 删除学号为5的学生记录。

**执行结果截图：**
![image-20251016164204152](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164204152.png)

### 2.3 更新操作 (UPDATE)

**操作内容：**
```sql
update students set age= age+1;
```

**功能说明：** 将所有学生的年龄增加1岁。

**执行结果截图：**

![image-20251016164237585](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164237585.png)

### 2.4 查询操作 (SELECT)

**操作内容：**
```sql
select name from students where age >= 22;
```

**功能说明：** 查询学号为5的学生的年龄。

**执行结果截图：**
![image-20251016164350794](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164350794.png)

## 三、级联外键实验

### 3.1 外键约束的定义

#### 3.1.1 级联外键定义
```sql
alter table students_courses
add constraint sc_students
foreign key (student_id) references students(id)
on delete cascade
on update cascade;
```

**功能说明：** 定义级联外键约束，当主表(students)中的记录被删除或更新时，从表(students_courses)中的相关记录也会被级联删除或更新。

#### 3.1.2 无级联外键定义
```sql
alter table students_courses
add constraint sc_students
foreign key (student_id) references students(id)
on delete no action
on update no action;
```

**功能说明：** 定义无级联外键约束，当主表中的记录被删除或更新时，从表中的相关记录不会受到影响。

### 3.2 级联外键约束的影响测试

#### 3.2.1 删除外键值（主键的）
```sql
DELETE FROM students WHERE id = 1;
```

**执行结果截图：**

![image-20251016164641828](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164641828.png)

发现，对于级联外键，删除时会删除所有和这个值相关的数据，在students表中和course表中都删除了id=1的学生信息

#### 3.2.2 修改外键值（主键的）
```sql
UPDATE students SET id = 2 WHERE id = 10;
```

![image-20251016164949418](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016164949418.png)

发现修改其主键值，和这个值相关的所有数据会自动修改

#### 3.2.3 增加外键值（主键的）

```sql
INSERT INTO students (id, name, age) VALUES (6, 'Emily', 24);
```

![image-20251016165959539](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016165959539.png)



**综上，也就是说，如果是级联外键，修改其主键值，其余相应的键值会一起修改**



#### 3.2.4 删除外键值（外键的）

```sql
delete from students_courses
where student_id = 3;
```

![image-20251016170647274](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016170647274.png)

顺利删除，删除了student_id = 3的课程情况

#### 3.2.5 修改外键值（外键的）

```sql
update students_courses
set student_id = 2
where student_id = 4;
```

![image-20251016172533151](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016172533151.png)

将id=4的学生改为2，成功修改



#### 3.2.6 增加外键值（外键的）

```sql
insert into students_courses values (4,1);
```

![image-20251016171118061](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016171118061.png)

顺利完成了插入新的数值



**综上，对于级联外键，可以自动维护主键和外键的一致性**



## 3.3 非级联外键实验


### 3.3.1 删除外键值（主键的）测试

```sql
DELETE FROM students WHERE id = 2;
```

**执行结果截图：**
![image-20251016173006923](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016173006923.png)

发现，对于非级联外键，删除主键值时会出现错误，因为存在外键引用，数据库会阻止删除操作以保持数据完整性。

### 3.3.2 修改外键值（主键的）测试

```sql
UPDATE students SET id = 8 WHERE id = 3;
```

**执行结果截图：**
![image-20251016173034117](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016173034117.png)

发现修改主键值也会出现错误，因为存在外键引用，数据库会阻止更新操作。

### 3.3.3 增加外键值（主键的）测试

```sql
INSERT INTO students (id, name, age) VALUES (6, 'Emily', 24);
```

**执行结果截图：**
![image-20251016173115906](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016173115906.png)

增加新的主键值可以正常执行，不受外键约束影响。

### 3.3.4 删除外键值（外键的）测试

```sql
delete from students_courses
where student_id = 4;
```

**执行结果截图：**
![image-20251016173220616](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016173220616.png)

可以正常删除外键表中的记录。

### 3.3.5 修改外键值（外键的）测试

```sql
update students_courses
set student_id = 7
where student_id = 4;
```

**执行结果截图：**
![image-20251016173936315](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016173936315.png)

可以正常修改外键值，只要新的值在主表中存在。

### 3.3.6 增加外键值（外键的）测试

```sql
insert into students_courses values (2,2);
```

**执行结果截图：**
![image-20251016174007727](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016174007727.png)

可以正常插入新的外键记录，只要外键值在主表中存在。

**综上，对于非级联外键：**

- 不能删除被外键引用的主键记录
- 不能修改被外键引用的主键值
- 可以正常操作外键表中的记录（增删改查）
- 外键值必须引用存在的主键值



## 四、复杂查询

### 查询Mr. Smith教授的所有学生

**查询语句：**

```sql
select name from students--学生名
where id in (
    select student_id from students_courses--查出选了这些课的学生
    where course_id in (
        select course_id from instructors_courses
        where instructor_id = (
            select id from teachers
            where name = 'Mr. Smith'--查出老师教了几门课
        )
    )
);
```

**查询逻辑分析：**
1. 最内层查询：根据教师姓名'Mr. Smith'查找教师ID
2. 第二层查询：根据教师ID查找该教师教授的所有课程ID
3. 第三层查询：根据课程ID查找选修这些课程的学生ID
4. 最外层查询：根据学生ID查找学生姓名

**执行结果截图：**
![image-20251016174126646](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016174126646.png)

## 五、数据库对象的使用

### 5.1 CHECK约束

**创建CHECK约束：**
```sql
alter table students
add constraint check_age
check (age > 18);
```

**功能说明：** 为学生表添加年龄约束，确保学生年龄必须大于18岁。

**测试截图：**

![image-20251016174303637](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016174303637.png)

可以看到，如果需要插入不满足check指令的数据会报错（这里和课上学的断言效果类似，但是这个数据库不支持create assertion指令）

### 5.2 视图的创建

**创建视图：**
```sql
create view student_view as
    select id,name from students
    where age > 20;
```

**功能说明：** 创建一个名为student_view的视图，包含年龄大于20岁的学生的学号和姓名。

**视图查询截图：**
![image-20251016174608539](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016174608539.png)

### 5.3 索引的创建

**创建索引：**
```sql
create index index_name on students(name);
```

**功能说明：** 为学生表的姓名字段创建索引，提高按姓名查询的性能。

**索引创建截图：**

![image-20251016174641896](C:\Users\11744\AppData\Roaming\Typora\typora-user-images\image-20251016174641896.png)


